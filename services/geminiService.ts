import { GoogleGenAI } from "@google/genai";
import { GroundingSource } from "../types";

export const sendMessageToGemini = async (
  prompt: string,
  history: { role: string; parts: { text: string }[] }[],
  countryContext?: string
): Promise<{ text: string; sources: GroundingSource[] }> => {
  
  // Initialize Gemini Client
  // The API key is obtained exclusively from process.env.API_KEY as per coding guidelines.
  const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

  try {
    // Map internal history to Gemini Content format
    const contents = history.map(msg => ({
      role: msg.role === 'user' ? 'user' : 'model',
      parts: msg.parts.map(p => ({ text: p.text }))
    }));

    // Append the current prompt
    contents.push({
      role: 'user',
      parts: [{ text: prompt }]
    });

    // Construct System Instruction based on context
    let systemInstruction = "You are the 'Crypto Regulations Guide', an elite AI compliance engine for Web3 institutions and founders. Your goal is to provide precise, up-to-date, and professional information regarding global crypto regulations (MiCA, SEC, VARA, MAS, etc.), anti-money laundering (AML) directives, and compliance risk factors. Always cite your sources when possible.";

    if (countryContext) {
      systemInstruction += `\n\nCRITICAL CONTEXT: You are currently acting as a specialized legal guide for **${countryContext}**. Focus your answers strictly on the regulatory framework, licensing requirements (e.g., SEC for USA, VARA for Dubai, MAS for Singapore), and compliance nuances specific to ${countryContext}. If the user asks a general question, frame your answer within the context of ${countryContext}'s laws.`;
    }

    const response = await ai.models.generateContent({
      model: 'gemini-3-pro-preview',
      contents: contents,
      config: {
        tools: [{ googleSearch: {} }],
        systemInstruction: systemInstruction,
      },
    });

    // Extract Text
    const text = response.text || "No content generated by the compliance engine.";

    // Extract Sources (Grounding)
    const sources: GroundingSource[] = [];
    
    // Check for grounding metadata
    const candidates = response.candidates;
    if (candidates && candidates[0] && candidates[0].groundingMetadata) {
      const chunks = candidates[0].groundingMetadata.groundingChunks;
      if (chunks) {
        chunks.forEach((chunk: any) => {
          if (chunk.web) {
            sources.push({
              title: chunk.web.title || "Regulatory Source",
              uri: chunk.web.uri
            });
          }
        });
      }
    }

    return { text, sources };

  } catch (error) {
    console.error("Gemini Service Error:", error);
    
    return {
      text: "⚠️ **Compliance Engine Error**\n\nUnable to connect to the regulatory intelligence network. Please ensure your API key is valid and you have an active internet connection.",
      sources: []
    };
  }
};